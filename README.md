# ddap

## 배경
브랜드사업부의 트랜드패션, 라이프패션 팀은 방송에 나오는 상품을 6개월 전에 기획한다. 
이 때 컬러별, 사이즈별로 얼마나 생산해야하는지 결정한다.
가장 중요한 것은 일부 컬러, 사이즈만 품절이 나오지 않게 적정 수량을 맞추는 것이다. 

> S/M/L 어떤 사이즈를 더 많이 생산해야할까?

기존에는 과거 주문 실적 통계를 참조했다.
하지만 주문 집계에는 일시품절이 반영되어 있지 않다.
자사에는 언제 품절이 떴는지 기록한 데이터가 없기 때문이다.

> 60분 방송 가운데 블랙 95가 20분 만에 매진, 블랙 100이 40분 만에 매진됐으나 105는 끝까지 판매중이다.
이를 방송 종료 후 실적 집계만 고려하면 뭐가 더 잘 팔렸는지 판단할 수가 없다.
 
조기품절을 반영한 실적 집계가 가능하다면 영업은 더욱 정확한 데이터로 정밀한 상품 기획을 할 수 있을 것이다.   

데이터 관점에서는 가치 있는 내부 데이터를 생산하고자 한다.
데이터에 대한 니즈는 굉장히 높으나 니즈를 충족시킬 수 있는 고부가가치의 정제된 내부 데이터는 없다. 
일시품절 시점, 추정 판매량처럼 향후 가치 있게 사용될 수 있는 데이터를 생산/적재하였고 이를 향후 활용할 수 있게
데이터 일관성 및 정확성에도 노력을 기울였다.



## 프로젝트로 얻을 수 있는 것
1. 방송 단위로 속성코드별 판매량 데이터 제공
1. 방송중 일시품절 시점 데이터 (추정치)
1. 일시품절로 인한 판매량 loss 추정
1. 향후 일시품절이 발생하지 않도록 사이즈 아소트 비중 추천



## 사용처
* 브랜드사업부 MD 직매입 상품 발주
    * 아소트 기획에 참고 데이터 제공 [사례1](https://gsshop.facebook.com/groups/363350254225960/permalink/466729900554661/) [사례2](https://gsshop.facebook.com/groups/363350254225960/permalink/466737627220555/) [사례3](https://gsshop.facebook.com/groups/363350254225960/permalink/426789121215406/)
* [무통장경험개선 과제](https://gsshop-ai.atlassian.net/wiki/spaces/~63121494/pages/50200629?atlOrigin=eyJpIjoiZTI5YmUxODY0Njc4NGFlNWI0MTZhMWZiY2M0YTA2MzYiLCJwIjoiYyJ9)
    * 일시품절이 일어난 방송 집계



## 용어 정의
+ **아소트**  
    컬러/사이즈와 같이 상품에 달려 있는 옵션 항목을 통칭  
+ **속성코드**  
    상품코드 하위개념으로 아소트와 동일
+ **공급약속수량**  
    데이터로서 의미는 재고수량과 동일
+ **아소트깨짐**  
    예를 들어 옵션으로 사이즈 S/M/L이 있는데 L이 매진되고 S/M만 남아있는 경우 재고가 아소트별로 불균형하게 된다.
    이러한 아소트별 재고가 불균형한 케이스를 일컫는다.   
    아소트깨짐이 중요한 이유는 다음 방송을 잡을 때 장애요인이 되기 때문이다. 
    메인 아소트가 깨진 경우에는 실질적으로 판매가 어렵고 편성팀에서 방송을 잡아주지 않는다.
    이러한 경우에는 모바일 매장 등 라이브 방송보다 구매력이 낮은 채널로 재고 소진해야하는데 현실적으로 어렵다.
    이러한 아소트깨짐 문제를 막기 위해 ddap가 개발되었다.  
+ **첫일시품절시수량**  
    방송 중인 속성코드 가운데 처음 일시품절이 발생한 순간의 누적 주문량.
    방송판매에서 속성코드 일시품절이 처음 발생한 순간의 실적을 snapshot 뜬 것이다.
+ **추정기대수요수량**  
    아소트별 재고가 충분히 있었다면 얼마를 팔 수 있었는지 나타낸다.
    각 아소트별로 일시품절 이전까지의 주문 데이터를 학습한 모델로 
    일시품절 이후 주문량을 추정하여 합계를 낸 것이다.
    알고리즘 관점에선 아소트를 user, 방송시간을 item, rating을 분당 판매량으로 두고 matrix factorization을 돌린 결과값.


## 데이터 사용자를 위한 안내사항

* 데이터 위치는 dhub의 `DTA_OWN.DDAP_REPORT_AUTO` `DTA_OWN.DDAP_SOLDOUT_SNAPSHOT_AUTO`이며 전자의 경우 한글 컬럼명으로 데이터 설명을 대신한다. 
* 회사 내부 데이터가 정제된 형태가 아니기 때문에 전처리를 꼼꼼히 했음에도 데이터가 완벽하게 clean하지 않다. 
* 일부 누락된 방송 또는 상품이 있을 수 있다.
* 주문 데이터는 **방송중 주문**만을 사용한다. 주문 채널은 구분하지 않는다.
* 주문량 기준은 `F_ORD_BROAD_RLRSLT_S`의 방송중주문과 동일하게 설정했다. 
* 미리주문은 별도 집계하며 당일 오전 03시부터 값만 집계한다.
* 품절로 처리하는 과정에서 실제주문을 왜곡하기 때문에 추정 기대수요가 실제 주문보다 작을 수 있다. 
* 아소트 추정은 수요 예측이 아닌 최적 비율 산정을 위함이므로 수량보다는 비율에 중점을 두길 권장한다.


## 분석대상
1. 분석의 기본 단위는 방송코드(PGM_ID), 상품코드 쌍이다. 방송 단위, 상품 단위로 MF 학습셋을 만든다.
1. 주문이 발생한 time window 길이가 5 이하인 방송은 예측에서 제외한다. 너무 주문이 적은 경우엔 예측이 무의미하므로 주문 fact 데이터를 그대로 사용한다.


## 일시품절 추정
일시품절에 대한 fact 데이터는 존재하지 않기 때문에 일시품절시점을 파악하는 건 추정만 가능하다. 
추정에서 고려사항은 공급약속수량이 절대적인 기준이 아니라는 것이다.
이는 생방송 판매 운영상의 이유로 실제 재고수량보다 낮은 수준에서 품절을 걸기도 하고,
실제 재고수량보다 높은 수준까지 판매가 되기 때문이다.  

데이터를 살펴보면 다양한 케이스가 있는데
1. 공급수량이 0 또는 `null` 
    * 주문제작인 보석 상품군
    * 심야시간대(대략 01 ~ 06시)에 진행하는 순환방송
1. 공급수량 < 주문수량
    * 가주문을 받는 경우도 있다.
1. 공급수량 > 주문수량 이지만 주문이 증가하지 않는 경우
    * GSTS에서 콜주문 운영시 어느 정도 선점한 수량이 있다고 한다. 그 수량을 뺀 나머지 수량이 총 재고가 된다.

또한 실제로 공급수량은 방송 중에 MD가 수정가능한데 이를 data hub에서 반영하는지 확인이 필요하다.  

따라서 `공급약속수량 = 주문량` 시점을 일시품절로 잡기에는 현실적으로 무리가 있다.
이에 정확도를 어느 정도 희생하지만 현실적으로 작동하는 수준의 정의가 필요하다.

### 일시품절 정의
1. 공급 = 0 또는 `Null` 일 때 일시품절 없음
1. 공급 < 주문 발생한 순간 품절
1. 공급 > 주문 and 공급 90% < 주문 일 때, 주문이 일정시간 증가하지 않으면 품절 
    1. `buffer` 를 초과한 주문량이 일정 기간 증가하지 않으면 품절로 처리

해당 내용은 `src.data_process.find_sold_out`에 구현


## environment
anaconda python 3.7

`conda env create -n ddap-batch -f environment.yml`


## 실행
    
    # dhub 접속 가능한 환경에서
    conda activate ddap-batch
    python -m main


## 알고리즘

+ **matrix factorization**
    입력 데이터는 방송코드, 상품코드 쌍을 가지고 구분하기 때문에 방송에서 3개의 상품코드를 판매하면 3개의 데이터셋을 학습한다. 
    브랜드 PGM은 상품마다 노출 시간이 정해져있기 때문에 이런 방식을 선택했다.   
    
    속성코드별로 일시품절 시점을 추정하여 해당 시점 이후의 주문을 `null` 처리한다. 
    (이에 따른 데이터 손실이 발생한다)  
    아소트를 user, 방송시간을 item, rating을 분당 판매량으로 두고 matrix factorization fitting.
    다양한 방송 케이스를 모두 만족하는 단일 parameter를 찾기 어렵기 때문에 
    5 fold cv로 parameter grid search를 통해 결정한다. (parameter gird는 휴리스틱으로 결정되었다)
    best parameter로 `null` 처리된 주문량을 impute한다.   
    
모델 성능보다는 빠른 개발 및 실행에 중점을 두어
`surprise.prediction_algorithms.matrix_factorization.SVD`를 사용하고 있으며 알고리즘 개선은 향후 과제로 남긴다.

> 실험적으로 [bayesian mf](https://gsshop-ai.atlassian.net/wiki/spaces/~387317790/pages/74416625/bayesian+probability+matrix+factorzation)를 사용해봤으나 예측 성능이 떨어져 사용하지 않음.


## 한계

1. 추정 기대수요는 라이브 방송에 최적화된 값이다. 분당 주문량이 꾸준히 발생한 경우에서 알고리즘이 정상적으로 작동한다.
1. 판매수량은 extreme value가 발생하는 경우가 있으며 이를 보정하기 위해 비율값을 보는 것이 좋다.
1. 일시품절 시점은 오차가 다소 크다.
1. 실행 성능 최적화가 되지 않았다.
1. 코드 확장성이 낮다.
